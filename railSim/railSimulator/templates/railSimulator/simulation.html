{% extends 'railSimulator/base.html' %}
{% load static %}

{% block content %}
    <h1>RAILSYS</h1>
    <div class="container">

        {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="padding: 15px; border-radius: 5px; margin-bottom: 10px; font-weight: bold;
                        {% if message.tags == 'error' %} 
                            background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; /* Rojo para error */
                        {% elif message.tags == 'success' %} 
                            background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; /* Verde para Ã©xito */
                        {% else %}
                            background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; /* Azul por defecto */
                        {% endif %}">
                        
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <div class="panel" style="margin-bottom: 40px;">
    <h2>Timetable Generator</h2>
    <form method="post">
        {% csrf_token %}
        
        <label>Trip Length (Stations): <input type="number" name="trip" value="{{ trip }}" required></label>
        
        <label>Start Hour (HH:MM): <input type="text" name="startHour" value="{{ startHour }}" placeholder="06:00" required></label>
        
        <label>End Hour (HH:MM): <input type="text" name="endHour" value="{{ endHour }}" placeholder="23:00" required></label>
        
        <label>Number of Lines: <input type="number" name="lines" value="{{ lines }}" required></label>
        
        <label>Security Margin (min): <input type="number" name="secuMargin" value="{{ secuMargin }}" required></label>
        
        <label>Lower Duration Margin: <input type="number" name="lMargin" value="{{ request.session.lMargin }}" required></label>
        
        <label>Higher Duration Margin: <input type="number" name="hMargin" value="{{ request.session.hMargin }}" required></label>

        <button type="submit" style="margin-top: 10px;">Generate Simulation</button>
    </form>
</div>
        <!-- Formulario Capacidad -->
        <details>
            <summary style="font-weight: bold; font-size: 18px; cursor: pointer;">Capacity</summary>
                <div class="panel" style="margin-bottom: 40px;">
                    <h2>Capacity Calculator</h2>
                    <form method="post" action="{% url 'generate_capacity' %}">
                        {% csrf_token %}
                        <label>Station Origin (A-Z): <input type="text" id="stationOrg" name="stationOrg"></label>
                        <label>Station End (A-Z): <input type="text" id="stationEnd" name="stationEnd"></label>
                        <label>Start Hour (HH:mm): <input type="text" id="startHourCapacity" name="startHourCapacity"></label>
                        <label>End Hour (HH:mm): <input type="text" id="endHourCapacity" name="endHourCapacity"></label>
                        <button type="submit">Submit</button>
                    </form>

                    {% if ocupation %}
                        <div style="margin-top: 20px;">
                            <strong>Capacidad calculada:</strong>
                        </div>

                        <div style="margin-top: 10px; width: 100%; max-width: 400px;">
                            <div style="
                                background-color: #eee;
                                border-radius: 8px;
                                overflow: hidden;
                                box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
                            ">
                                <div style="
                                    width: {{ ocupation }}%;
                                    background-color: {% if ocupation < 60 %}#4caf50{% elif ocupation < 85 %}#ffc107{% else %}#f44336{% endif %};
                                    height: 24px;
                                    text-align: center;
                                    color: white;
                                    font-weight: bold;
                                    line-height: 24px;
                                    transition: width 0.5s;
                                ">
                                    {{ ocupation }}%
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </details>
    </div>

    <div>
        <h2>Subir archivo</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="uploaded_file" required>
            <button type="submit" name="upload_button">Submit</button>
        </form>
    </div>
    
    <div style="display: flex; align-items: flex-start; gap: 20px;">

    <!-- Tabla -->
    <details class="table">
        <summary style="font-weight: bold; font-size: 18px; cursor: pointer;">Ver tabla de horarios</summary>
        <table border="1">
            <thead>
                <tr>
                    <th>Linea</th>
                    <th>Stations</th>
                    <th>Departure Times</th>
                    <th>Arrival Times</th>
                </tr>
            </thead>
            <tbody>
                {% for line in train_lines %}
                <tr>
                    <td>{{ line.Linea }}</td>
                    <td>
                        {% if line.Stations %}
                            {{ line.Stations|join:", " }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if line.Departures %}
                            <ul>
                            {% for hora in line.Departures %}
                                <li>{{ forloop.counter }}. {{ hora }}</li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if line.Arrivals %}
                            <ul>
                            {% for hora in line.Arrivals %}
                                <li>{{ forloop.counter }}. {{ hora }}</li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </details>

    <!-- Imagen a la derecha -->
    <div class="diagram" style="max-width: 1500px;">
        <img src="{% static 'img/diagrama.png' %}?v={{ timestamp }}" alt="Diagrama" style="width: 100%; height: auto; border: 1px solid #ccc;">
    </div>
</div>
{% endblock %}